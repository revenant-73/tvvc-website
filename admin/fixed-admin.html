<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TVVC Admin - Tryout Registrations</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <style>
    :root {
      --color-teal: #008080;
      --color-teal-dark: #006666;
      --color-coral: #ff6b6b;
      --color-coral-dark: #e05c5c;
      --color-dark: #121212;
      --color-dark-surface: #1a1a1a;
      --color-gray-100: #f5f5f5;
      --color-gray-200: #e0e0e0;
      --color-gray-300: #cccccc;
      --color-gray-400: #aaaaaa;
      --color-gray-500: #888888;
      --color-gray-600: #666666;
      --color-gray-700: #444444;
      --color-gray-800: #333333;
      --color-gray-900: #222222;
      --color-white: #ffffff;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      --spacing-3xl: 64px;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-full: 9999px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--color-dark);
      color: var(--color-white);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }
    
    .header {
      background-color: var(--color-dark-surface);
      padding: var(--spacing-lg) 0;
      border-bottom: 1px solid var(--color-gray-800);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--color-teal);
    }
    
    .logo span {
      color: var(--color-coral);
    }
    
    .admin-title {
      font-size: 0.9rem;
      color: var(--color-gray-400);
      margin-left: var(--spacing-md);
      padding-left: var(--spacing-md);
      border-left: 1px solid var(--color-gray-700);
    }
    
    .auth-section {
      background-color: var(--color-dark-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-top: var(--spacing-xl);
      box-shadow: var(--shadow-lg);
      text-align: center;
    }
    
    .auth-form {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .form-group {
      margin-bottom: var(--spacing-lg);
    }
    
    .form-label {
      display: block;
      margin-bottom: var(--spacing-xs);
      color: var(--color-gray-300);
      font-weight: 600;
      text-align: left;
    }
    
    .form-input {
      width: 100%;
      padding: var(--spacing-md);
      background-color: var(--color-gray-900);
      border: 1px solid var(--color-gray-700);
      border-radius: var(--radius-md);
      color: var(--color-white);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--color-teal);
      box-shadow: 0 0 0 2px rgba(0, 128, 128, 0.2);
    }
    
    .btn {
      display: inline-block;
      padding: var(--spacing-md) var(--spacing-xl);
      background-color: var(--color-teal);
      color: var(--color-white);
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .btn:hover {
      background-color: var(--color-teal-dark);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background-color: var(--color-gray-700);
    }
    
    .btn-secondary:hover {
      background-color: var(--color-gray-600);
    }
    
    .btn-coral {
      background-color: var(--color-coral);
    }
    
    .btn-coral:hover {
      background-color: var(--color-coral-dark);
    }
    
    .admin-panel {
      display: none;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--color-gray-800);
    }
    
    .panel-title {
      font-size: 1.5rem;
      margin-bottom: 0;
    }
    
    .action-buttons {
      display: flex;
      gap: var(--spacing-md);
    }
    
    .registrations-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--spacing-xl);
    }
    
    .registrations-table th,
    .registrations-table td {
      padding: var(--spacing-md);
      text-align: left;
      border-bottom: 1px solid var(--color-gray-800);
    }
    
    .registrations-table th {
      background-color: var(--color-gray-900);
      color: var(--color-gray-300);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .registrations-table tbody tr {
      transition: background-color 0.3s ease;
    }
    
    .registrations-table tbody tr:hover {
      background-color: var(--color-gray-900);
    }
    
    .table-container {
      max-height: 600px;
      overflow-y: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-gray-800);
      margin-bottom: var(--spacing-xl);
    }
    
    .empty-state {
      text-align: center;
      padding: var(--spacing-3xl) var(--spacing-xl);
      color: var(--color-gray-500);
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: var(--spacing-lg);
      color: var(--color-gray-700);
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }
    
    .stat-card {
      background-color: var(--color-dark-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border-left: 4px solid var(--color-teal);
    }
    
    .stat-title {
      font-size: 0.9rem;
      color: var(--color-gray-400);
      margin-bottom: var(--spacing-xs);
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--color-white);
    }
    
    .error-message {
      color: var(--color-coral);
      margin-top: var(--spacing-xs);
      font-size: 0.9rem;
      text-align: left;
    }
    
    .success-message {
      background-color: rgba(0, 128, 128, 0.1);
      color: var(--color-teal);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
    }
    
    .success-message i {
      margin-right: var(--spacing-sm);
    }
    
    .footer {
      margin-top: var(--spacing-3xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--color-gray-800);
      color: var(--color-gray-500);
      font-size: 0.9rem;
      text-align: center;
    }
    
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-pending {
      background-color: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }
    
    .status-confirmed {
      background-color: rgba(33, 150, 243, 0.2);
      color: #2196f3;
    }
    
    .status-paid {
      background-color: rgba(0, 128, 128, 0.2);
      color: var(--color-teal);
    }
    
    .status-completed {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }
    
    .status-cancelled {
      background-color: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }
    
    /* Status update buttons */
    .status-update-btn {
      padding: 8px 12px;
      font-size: 0.9rem;
    }
    
    .status-update-btn[data-status="pending"] {
      background-color: #ff9800;
    }
    
    .status-update-btn[data-status="confirmed"] {
      background-color: #2196f3;
    }
    
    .status-update-btn[data-status="paid"] {
      background-color: var(--color-teal);
    }
    
    .status-update-btn[data-status="completed"] {
      background-color: #4caf50;
    }
    
    .status-update-btn[data-status="cancelled"] {
      background-color: #f44336;
    }
    
    /* Action buttons */
    .action-btn {
      background: none;
      border: none;
      color: var(--color-gray-400);
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
      transition: all 0.3s ease;
      margin-right: 8px;
    }
    
    .action-btn:hover {
      color: var(--color-white);
      transform: translateY(-2px);
    }
    
    .view-btn:hover {
      color: var(--color-teal);
    }
    
    .delete-btn:hover {
      color: var(--color-coral);
    }
    
    /* Details modal styles */
    .details-item {
      margin-bottom: 12px;
    }
    
    .details-label {
      font-weight: 600;
      color: var(--color-gray-300);
      margin-right: 8px;
      display: inline-block;
      min-width: 120px;
    }
    
    .details-value {
      color: var(--color-white);
    }
    
    .close-modal:hover {
      color: var(--color-white);
      transform: rotate(90deg);
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }
    
    .fa-spinner {
      font-size: 3rem;
      color: var(--color-teal);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: var(--spacing-lg);
      }
      
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .admin-title {
        margin-left: 0;
        padding-left: 0;
        border-left: none;
        margin-top: var(--spacing-xs);
      }
      
      .panel-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .action-buttons {
        margin-top: var(--spacing-md);
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      /* Responsive table for mobile */
      .registrations-table thead {
        display: none; /* Hide table headers */
      }
      
      .registrations-table tbody tr {
        display: block;
        margin-bottom: 16px;
        border: 1px solid var(--color-gray-800);
        border-radius: var(--radius-md);
        padding: 16px;
        background-color: var(--color-dark-surface);
      }
      
      .registrations-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--color-gray-900);
      }
      
      .registrations-table td:last-child {
        border-bottom: none;
      }
      
      .registrations-table td:before {
        content: attr(data-label);
        font-weight: 600;
        margin-right: 8px;
        color: var(--color-gray-300);
      }
      
      .action-btn {
        font-size: 1.2rem;
        padding: 8px;
        margin-right: 12px;
        min-height: 44px;
        min-width: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Form improvements for mobile */
      .form-input,
      .form-textarea,
      select.form-input {
        padding: 14px;
        font-size: 16px; /* Prevents iOS zoom on focus */
        min-height: 50px; /* Larger touch target */
      }
      
      .btn {
        padding: 14px 20px;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-content">
      <div style="display: flex; align-items: center;">
        <div class="logo">TVVC<span>.</span></div>
        <div class="admin-title">Admin Dashboard</div>
      </div>
      <div id="auth-status" style="display: flex; gap: 10px;">
        <a href="/" class="btn" style="background-color: var(--color-coral);">
          <i class="fas fa-home"></i> Return to Website
        </a>
        <button id="logout-btn" class="btn btn-secondary" style="display: none;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </header>
  
  <main class="container">
    <section id="auth-section" class="auth-section">
      <h2>Admin Login</h2>
      <p style="margin-bottom: var(--spacing-lg); color: var(--color-gray-400);">
        Please enter your password to access the tryout registration data.
      </p>
      
      <form id="auth-form" class="auth-form">
        <div class="form-group">
          <label for="password" class="form-label">Password</label>
          <input type="password" id="password" class="form-input" required>
          <div id="auth-error" class="error-message" style="display: none;"></div>
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">
          <i class="fas fa-lock"></i> Login
        </button>
      </form>
      
      <p style="margin-top: 20px; font-size: 0.9rem; color: var(--color-gray-500);">
        Having trouble logging in? <a href="reset-auth.html" style="color: var(--color-teal);">Reset authentication</a>
      </p>
      
      <div style="margin-top: 30px;">
        <a href="/" class="btn" style="background-color: var(--color-coral);">
          <i class="fas fa-home"></i> Return to Website
        </a>
      </div>
    </section>
    
    <section id="admin-panel" class="admin-panel">
      <div id="success-message" class="success-message" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="success-text">Operation completed successfully!</span>
      </div>
      
      <div class="panel-header">
        <h2 class="panel-title">Tryout Registrations</h2>
        
        <div class="action-buttons">
          <button id="export-csv-btn" class="btn">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button id="clear-data-btn" class="btn btn-coral">
            <i class="fas fa-trash-alt"></i> Clear Data
          </button>
        </div>
      </div>
      
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-title">Total Registrations</div>
          <div id="total-registrations" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Age Groups</div>
          <div id="age-groups" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Latest Registration</div>
          <div id="latest-registration" class="stat-value">-</div>
        </div>
      </div>
      
      <div class="table-container">
        <table class="registrations-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Player Name</th>
              <th>Age Group</th>
              <th>Position</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="registrations-table-body">
            <!-- Registration rows will be added here dynamically -->
          </tbody>
        </table>
        
        <div id="empty-state" class="empty-state" style="display: none;">
          <div class="empty-icon">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <h3>No Registrations Yet</h3>
          <p>When players register for tryouts, they will appear here.</p>
        </div>
        
        <div id="loading-spinner" class="loading-spinner" style="display: none; text-align: center; padding: 40px;">
          <i class="fas fa-spinner fa-spin"></i>
          <p style="margin-top: 20px; color: var(--color-gray-400);">Loading registrations...</p>
        </div>
      </div>
      
      <!-- Registration Details Modal -->
      <div id="details-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; overflow: auto;">
        <div style="background-color: var(--color-dark-surface); margin: 10% auto; padding: 20px; width: 80%; max-width: 700px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--color-gray-800);">
            <h3 id="detail-title" style="margin: 0;">Registration Details</h3>
            <button id="close-details" class="close-modal" style="background: none; border: none; color: var(--color-gray-400); font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4 style="color: var(--color-teal); margin-bottom: 15px;">Player Information</h4>
              
              <div class="details-item">
                <span class="details-label">Name:</span>
                <span id="detail-player-name" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Birth Date:</span>
                <span id="detail-birth-date" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Age Group:</span>
                <span id="detail-age-group" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Grade:</span>
                <span id="detail-grade" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">School:</span>
                <span id="detail-school" class="details-value"></span>
              </div>
              
              <h4 style="color: var(--color-teal); margin-top: 25px; margin-bottom: 15px;">Volleyball Experience</h4>
              
              <div class="details-item">
                <span class="details-label">Primary Position:</span>
                <span id="detail-position" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Secondary:</span>
                <span id="detail-secondary-position" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Experience:</span>
                <span id="detail-experience" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Previous Club:</span>
                <span id="detail-previous-club" class="details-value"></span>
              </div>
            </div>
            
            <div>
              <h4 style="color: var(--color-teal); margin-bottom: 15px;">Parent/Guardian Information</h4>
              
              <div class="details-item">
                <span class="details-label">Name:</span>
                <span id="detail-parent-name" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Email:</span>
                <span id="detail-parent-email" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Phone:</span>
                <span id="detail-parent-phone" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Address:</span>
                <span id="detail-parent-address" class="details-value"></span>
              </div>
              
              <h4 style="color: var(--color-teal); margin-top: 25px; margin-bottom: 15px;">Registration Details</h4>
              
              <div class="details-item">
                <span class="details-label">Date:</span>
                <span id="detail-date" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Tryout Session:</span>
                <span id="detail-tryout-session" class="details-value"></span>
              </div>
              <div class="details-item">
                <span class="details-label">Status:</span>
                <span id="detail-status" class="details-value"></span>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h4 style="color: var(--color-teal); margin-bottom: 15px;">Update Status</h4>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
              <button class="btn status-update-btn" data-status="pending">
                <i class="fas fa-clock"></i> Pending
              </button>
              <button class="btn status-update-btn" data-status="confirmed">
                <i class="fas fa-check"></i> Confirmed
              </button>
              <button class="btn status-update-btn" data-status="paid">
                <i class="fas fa-dollar-sign"></i> Paid
              </button>
              <button class="btn status-update-btn" data-status="completed">
                <i class="fas fa-check-double"></i> Completed
              </button>
              <button class="btn status-update-btn" data-status="cancelled">
                <i class="fas fa-ban"></i> Cancelled
              </button>
            </div>
          </div>
          
          <div style="margin-top: 30px; display: flex; justify-content: space-between;">
            <div>
              <button id="detail-delete-btn" class="btn btn-coral">
                <i class="fas fa-trash-alt"></i> Delete Registration
              </button>
            </div>
            <div>
              <button id="detail-close-btn" class="btn btn-secondary">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <footer class="footer container">
    <p>&copy; 2025 Tualatin Valley Volleyball Club. All rights reserved.</p>
  </footer>
  
  <script src="firebase-admin.js"></script>
  <script>
    // Admin password - change this to your desired password
    const ADMIN_PASSWORD = 'tvvcadmin2024';
    
    // DOM Elements
    const authSection = document.getElementById('auth-section');
    const authForm = document.getElementById('auth-form');
    const authError = document.getElementById('auth-error');
    const adminPanel = document.getElementById('admin-panel');
    const logoutBtn = document.getElementById('logout-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const registrationsTableBody = document.getElementById('registrations-table-body');
    const emptyState = document.getElementById('empty-state');
    const loadingSpinner = document.getElementById('loading-spinner');
    const totalRegistrationsEl = document.getElementById('total-registrations');
    const ageGroupsEl = document.getElementById('age-groups');
    const latestRegistrationEl = document.getElementById('latest-registration');
    const successMessage = document.getElementById('success-message');
    const successText = document.getElementById('success-text');
    const detailsModal = document.getElementById('details-modal');
    
    // Current registrations data
    let currentRegistrations = [];
    let currentRegistrationId = null;
    
    // Check if user is already authenticated
    function checkAuth() {
      const isAuthenticated = localStorage.getItem('tvvc_admin_auth') === 'true';
      
      // Clear any previous error messages
      authError.style.display = 'none';
      
      if (isAuthenticated) {
        showAdminPanel();
      } else {
        showAuthForm();
      }
    }
    
    // Show the authentication form
    function showAuthForm() {
      authSection.style.display = 'block';
      adminPanel.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
    
    // Show the admin panel
    function showAdminPanel() {
      authSection.style.display = 'none';
      adminPanel.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
      
      // Load registrations data
      loadRegistrations();
    }
    
    // Handle authentication form submission
    authForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      
      console.log("Login attempt with password:", password);
      
      if (password === ADMIN_PASSWORD) {
        console.log("Password correct, authenticating...");
        // Set authentication in localStorage
        localStorage.setItem('tvvc_admin_auth', 'true');
        
        // Show admin panel
        showAdminPanel();
        
        // Clear password field
        document.getElementById('password').value = '';
        authError.style.display = 'none';
      } else {
        console.log("Password incorrect");
        // Show error message
        authError.textContent = 'Incorrect password. Please try again. The password is: tvvcadmin2024';
        authError.style.display = 'block';
      }
    });
    
    // Handle logout
    logoutBtn.addEventListener('click', function() {
      // Clear authentication from localStorage
      localStorage.removeItem('tvvc_admin_auth');
      
      // Show auth form
      showAuthForm();
    });
    
    // Load registrations from Firestore
    async function loadRegistrations() {
      // Show loading spinner
      emptyState.style.display = 'none';
      registrationsTableBody.innerHTML = '';
      loadingSpinner.style.display = 'flex';
      
      try {
        // Fetch registrations from Firestore
        currentRegistrations = await fetchRegistrations();
        
        // Update stats
        updateStats(currentRegistrations);
        
        // Clear table body
        registrationsTableBody.innerHTML = '';
        
        // Check if there are any registrations
        if (currentRegistrations.length === 0) {
          // Show empty state
          emptyState.style.display = 'block';
          loadingSpinner.style.display = 'none';
          return;
        }
        
        // Hide empty state
        emptyState.style.display = 'none';
        
        // Populate table with registrations
        currentRegistrations.forEach(registration => {
          const row = document.createElement('tr');
          
          // Format date
          const date = registration.timestamp;
          const formattedDate = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });
          
          // Create status badge
          const statusBadge = document.createElement('span');
          statusBadge.className = `status-badge status-${registration.status.toLowerCase()}`;
          statusBadge.textContent = registration.status.charAt(0).toUpperCase() + registration.status.slice(1);
          
          // Create action buttons
          const actionButtons = document.createElement('div');
          
          const viewButton = document.createElement('button');
          viewButton.className = 'action-btn view-btn';
          viewButton.innerHTML = '<i class="fas fa-eye"></i>';
          viewButton.setAttribute('data-id', registration.id);
          viewButton.setAttribute('title', 'View Details');
          
          const deleteButton = document.createElement('button');
          deleteButton.className = 'action-btn delete-btn';
          deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
          deleteButton.setAttribute('data-id', registration.id);
          deleteButton.setAttribute('title', 'Delete Registration');
          
          actionButtons.appendChild(viewButton);
          actionButtons.appendChild(deleteButton);
          
          // Set row content
          row.innerHTML = `
            <td data-label="Date">${formattedDate}</td>
            <td data-label="Player Name">${registration.playerName}</td>
            <td data-label="Age Group">${registration.ageGroup}</td>
            <td data-label="Position">${registration.position}</td>
            <td data-label="Status"></td>
            <td data-label="Actions"></td>
          `;
          
          // Add status badge and action buttons
          row.cells[4].appendChild(statusBadge);
          row.cells[5].appendChild(actionButtons);
          
          // Add row to table
          registrationsTableBody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        addActionButtonListeners();
      } catch (error) {
        console.error('Error loading registrations:', error);
        showSuccessMessage('Error loading registrations. Please try again.', 'error');
      } finally {
        // Hide loading spinner
        loadingSpinner.style.display = 'none';
      }
    }
    
    // Add event listeners to action buttons
    function addActionButtonListeners() {
      // View buttons
      const viewButtons = document.querySelectorAll('.view-btn');
      viewButtons.forEach(button => {
        button.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          showRegistrationDetails(id);
        });
      });
      
      // Delete buttons
      const deleteButtons = document.querySelectorAll('.delete-btn');
      deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this registration?')) {
            deleteRegistrationById(id);
          }
        });
      });
    }
    
    // Show registration details
    function showRegistrationDetails(id) {
      // Find registration by ID
      const registration = currentRegistrations.find(reg => reg.id === id);
      
      if (!registration) {
        console.error('Registration not found:', id);
        return;
      }
      
      // Set current registration ID
      currentRegistrationId = id;
      
      // Format date
      const date = registration.timestamp;
      const formattedDate = date.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: 'numeric'
      });
      
      // Set details in modal
      document.getElementById('detail-title').textContent = `Registration Details: ${registration.playerName}`;
      document.getElementById('detail-player-name').textContent = registration.playerName;
      document.getElementById('detail-birth-date').textContent = registration.birthDate;
      document.getElementById('detail-age-group').textContent = registration.ageGroup;
      document.getElementById('detail-grade').textContent = registration.grade;
      document.getElementById('detail-school').textContent = registration.school;
      
      document.getElementById('detail-position').textContent = registration.position;
      document.getElementById('detail-secondary-position').textContent = registration.secondaryPosition;
      document.getElementById('detail-experience').textContent = registration.experienceLevel;
      document.getElementById('detail-previous-club').textContent = registration.previousClub;
      
      document.getElementById('detail-parent-name').textContent = registration.parentName;
      document.getElementById('detail-parent-email').textContent = registration.parentEmail;
      document.getElementById('detail-parent-phone').textContent = registration.parentPhone;
      document.getElementById('detail-parent-address').textContent = registration.parentAddress;
      
      document.getElementById('detail-date').textContent = formattedDate;
      document.getElementById('detail-tryout-session').textContent = registration.tryoutSession;
      
      // Create status badge
      const statusBadge = document.createElement('span');
      statusBadge.className = `status-badge status-${registration.status.toLowerCase()}`;
      statusBadge.textContent = registration.status.charAt(0).toUpperCase() + registration.status.slice(1);
      
      const statusContainer = document.getElementById('detail-status');
      statusContainer.innerHTML = '';
      statusContainer.appendChild(statusBadge);
      
      // Show modal
      detailsModal.style.display = 'block';
    }
    
    // Close details modal
    function closeDetailsModal() {
      detailsModal.style.display = 'none';
      currentRegistrationId = null;
    }
    
    // Delete registration by ID
    async function deleteRegistrationById(id) {
      // Show loading spinner
      loadingSpinner.style.display = 'flex';
      
      try {
        // Delete registration from Firestore
        const success = await deleteRegistration(id);
        
        if (success) {
          // Close modal if open
          if (currentRegistrationId === id) {
            closeDetailsModal();
          }
          
          // Show success message
          showSuccessMessage('Registration deleted successfully!');
          
          // Reload registrations
          loadRegistrations();
        } else {
          // Show error message
          showSuccessMessage('Error deleting registration. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error deleting registration:', error);
        showSuccessMessage('Error deleting registration. Please try again.', 'error');
      } finally {
        // Hide loading spinner
        loadingSpinner.style.display = 'none';
      }
    }
    
    // Update registration status
    async function updateRegistrationStatusById(id, status) {
      // Show loading spinner
      loadingSpinner.style.display = 'flex';
      
      try {
        // Update status in Firestore
        const success = await updateRegistrationStatus(id, status);
        
        if (success) {
          // Show success message
          showSuccessMessage(`Registration status updated to ${status}!`);
          
          // Reload registrations
          loadRegistrations();
          
          // Close modal if open
          if (currentRegistrationId === id) {
            closeDetailsModal();
          }
        } else {
          // Show error message
          showSuccessMessage('Error updating registration status. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error updating registration status:', error);
        showSuccessMessage('Error updating registration status. Please try again.', 'error');
      } finally {
        // Hide loading spinner
        loadingSpinner.style.display = 'none';
      }
    }
    
    // Update statistics
    function updateStats(registrations) {
      // Total registrations
      totalRegistrationsEl.textContent = registrations.length;
      
      // Age groups
      const ageGroups = new Set();
      registrations.forEach(reg => {
        if (reg.ageGroup) {
          ageGroups.add(reg.ageGroup);
        }
      });
      ageGroupsEl.textContent = ageGroups.size;
      
      // Latest registration
      if (registrations.length > 0) {
        const latestDate = new Date(Math.max(...registrations.map(reg => reg.timestamp.getTime())));
        const now = new Date();
        const diffTime = Math.abs(now - latestDate);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
          latestRegistrationEl.textContent = 'Today';
        } else if (diffDays === 1) {
          latestRegistrationEl.textContent = 'Yesterday';
        } else {
          latestRegistrationEl.textContent = `${diffDays} days ago`;
        }
      } else {
        latestRegistrationEl.textContent = '-';
      }
    }
    
    // Show success message
    function showSuccessMessage(message, type = 'success') {
      successText.textContent = message;
      
      // Set message type
      if (type === 'error') {
        successMessage.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
        successMessage.style.color = '#ff6b6b';
        successMessage.querySelector('i').className = 'fas fa-exclamation-circle';
      } else if (type === 'warning') {
        successMessage.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
        successMessage.style.color = '#ff9800';
        successMessage.querySelector('i').className = 'fas fa-exclamation-triangle';
      } else {
        successMessage.style.backgroundColor = 'rgba(0, 128, 128, 0.1)';
        successMessage.style.color = '#008080';
        successMessage.querySelector('i').className = 'fas fa-check-circle';
      }
      
      // Show message
      successMessage.style.display = 'flex';
      
      // Hide message after 5 seconds
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 5000);
    }
    
    // Export registrations to CSV
    function exportRegistrationsToCSV() {
      if (currentRegistrations.length === 0) {
        showSuccessMessage('No registrations to export.', 'warning');
        return;
      }
      
      // CSV headers
      const headers = [
        'Registration Date',
        'Player Name',
        'Birth Date',
        'Age Group',
        'Grade',
        'School',
        'Primary Position',
        'Secondary Position',
        'Experience Level',
        'Previous Club',
        'Parent Name',
        'Parent Email',
        'Parent Phone',
        'Parent Address',
        'Tryout Session',
        'Status'
      ];
      
      // CSV rows
      const rows = currentRegistrations.map(reg => [
        reg.timestamp.toLocaleDateString('en-US'),
        reg.playerName,
        reg.birthDate,
        reg.ageGroup,
        reg.grade,
        reg.school,
        reg.position,
        reg.secondaryPosition,
        reg.experienceLevel,
        reg.previousClub,
        reg.parentName,
        reg.parentEmail,
        reg.parentPhone,
        reg.parentAddress,
        reg.tryoutSession,
        reg.status
      ]);
      
      // Create CSV content
      let csvContent = headers.join(',') + '\n';
      
      rows.forEach(row => {
        // Escape fields with commas
        const escapedRow = row.map(field => {
          // Convert to string and handle null/undefined
          const str = (field !== null && field !== undefined) ? String(field) : '';
          
          // Escape quotes and wrap in quotes if contains comma
          if (str.includes(',') || str.includes('"')) {
            return `"${str.replace(/"/g, '""')}"`;
          }
          return str;
        });
        
        csvContent += escapedRow.join(',') + '\n';
      });
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `tvvc-tryout-registrations-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.display = 'none';
      
      // Add to document, click, and remove
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Show success message
      showSuccessMessage('Registrations exported to CSV successfully!');
    }
    
    // Clear all registrations
    async function clearAllRegistrationsData() {
      if (confirm('Are you sure you want to clear ALL registration data? This action CANNOT be undone.')) {
        if (confirm('This will permanently delete ALL tryout registrations. Type "DELETE" to confirm.')) {
          const confirmText = prompt('Type "DELETE" to confirm deletion of all registrations:');
          
          if (confirmText === 'DELETE') {
            // Show loading spinner
            loadingSpinner.style.display = 'flex';
            
            try {
              // Clear all registrations from Firestore
              const success = await clearAllRegistrations();
              
              if (success) {
                // Show success message
                showSuccessMessage('All registration data has been cleared successfully!');
                
                // Reload registrations
                loadRegistrations();
              } else {
                // Show error message
                showSuccessMessage('Error clearing registration data. Please try again.', 'error');
              }
            } catch (error) {
              console.error('Error clearing registrations:', error);
              showSuccessMessage('Error clearing registration data. Please try again.', 'error');
            } finally {
              // Hide loading spinner
              loadingSpinner.style.display = 'none';
            }
          } else {
            showSuccessMessage('Deletion cancelled.', 'warning');
          }
        }
      }
    }
    
    // Event listeners for modal
    document.getElementById('close-details').addEventListener('click', closeDetailsModal);
    document.getElementById('detail-close-btn').addEventListener('click', closeDetailsModal);
    document.getElementById('detail-delete-btn').addEventListener('click', function() {
      if (currentRegistrationId && confirm('Are you sure you want to delete this registration?')) {
        deleteRegistrationById(currentRegistrationId);
      }
    });
    
    // Add event listeners to status update buttons
    document.querySelectorAll('.status-update-btn').forEach(button => {
      button.addEventListener('click', function() {
        const status = this.getAttribute('data-status');
        if (currentRegistrationId) {
          if (confirm(`Are you sure you want to change the status to ${status.toUpperCase()}?`)) {
            updateRegistrationStatusById(currentRegistrationId, status);
          }
        }
      });
    });
    
    // Event listener for export CSV button
    exportCsvBtn.addEventListener('click', exportRegistrationsToCSV);
    
    // Event listener for clear data button
    clearDataBtn.addEventListener('click', clearAllRegistrationsData);
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target === detailsModal) {
        closeDetailsModal();
      }
    });
    
    // Initialize
    checkAuth();
  </script>
</body>
</html>