<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Tryout Registrations Admin - TVVC</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="../assets/site-styles.min.css">
  
  <style>
    /* Admin-specific styles */
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .admin-title {
      font-size: 1.8rem;
      margin: 0;
    }
    
    .admin-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background: var(--color-dark-surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    
    .admin-table th,
    .admin-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .admin-table th {
      background-color: rgba(0, 0, 0, 0.2);
      font-weight: 600;
      color: var(--color-teal);
    }
    
    .admin-table tr:hover {
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .admin-table tr:last-child td {
      border-bottom: none;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-pending {
      background-color: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }
    
    .status-approved {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .status-rejected {
      background-color: rgba(244, 67, 54, 0.2);
      color: #F44336;
    }
    
    .status-waitlist {
      background-color: rgba(33, 150, 243, 0.2);
      color: #2196F3;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .action-view {
      color: var(--color-teal);
    }
    
    .action-edit {
      color: #FFC107;
    }
    
    .action-delete {
      color: #F44336;
    }
    
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-label {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .filter-select {
      background-color: var(--color-dark-surface);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
    }
    
    .search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      background-color: var(--color-dark-surface);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.5);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal-content {
      background-color: var(--color-dark-surface);
      margin: 50px auto;
      padding: 30px;
      border-radius: var(--radius-lg);
      max-width: 800px;
      position: relative;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }
    
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.5);
      transition: color 0.2s ease;
    }
    
    .modal-close:hover {
      color: white;
    }
    
    .modal-title {
      margin-top: 0;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .detail-section {
      margin-bottom: 25px;
    }
    
    .detail-section-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: var(--color-teal);
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .detail-item {
      margin-bottom: 10px;
    }
    
    .detail-label {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-weight: 600;
    }
    
    .status-select {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      background-color: var(--color-dark-surface);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-top: 10px;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
    }
    
    .modal-btn {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-cancel {
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .btn-cancel:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .btn-save {
      background-color: var(--color-teal);
      border: none;
      color: white;
    }
    
    .btn-save:hover {
      background-color: var(--color-coral);
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 30px;
    }
    
    .page-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: var(--color-dark-surface);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .page-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .page-btn.active {
      background-color: var(--color-teal);
      border-color: var(--color-teal);
    }
    
    .export-btn {
      background-color: var(--color-teal);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    
    .export-btn:hover {
      background-color: var(--color-coral);
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--color-teal);
      animation: spin 1s linear infinite;
    }
    
    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .admin-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .admin-table {
        display: block;
        overflow-x: auto;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .search-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header" style="position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); background-color: rgba(18, 18, 18, 0.9); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;">
    <div class="container header-container">
      <a href="../index.html" class="logo" style="background: linear-gradient(135deg, var(--color-teal), var(--color-coral)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        <span>TVVC</span>
      </a>
      
      <nav class="main-nav" id="main-nav">
        <ul>
          <li><a href="../index.html" class="nav-link">Main Site</a></li>
          <li><a href="index.html" class="nav-link">Admin Dashboard</a></li>
          <li><a href="tryout-registrations.html" class="nav-link active">Tryout Registrations</a></li>
          <li><a href="#" id="logout-btn" class="nav-link" style="color: var(--color-coral);"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>
  
  <!-- Main Content -->
  <main class="admin-container">
    <div class="admin-header">
      <h1 class="admin-title">Tryout Registrations</h1>
      
      <div class="admin-controls">
        <button id="refresh-btn" class="btn" style="background-color: var(--color-teal);">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        
        <button id="export-csv" class="export-btn">
          <i class="fas fa-file-csv"></i> Export CSV
        </button>
      </div>
    </div>
    
    <div class="filters">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="search-input" class="search-input" placeholder="Search by name, email, or school...">
      </div>
      
      <div class="filter-group">
        <span class="filter-label">Age Group:</span>
        <select id="filter-age" class="filter-select">
          <option value="">All</option>
          <option value="12u">12U</option>
          <option value="13u">13U</option>
          <option value="14u">14U</option>
          <option value="15u">15U</option>
          <option value="16u">16U</option>
          <option value="17u">17U</option>
          <option value="18u">18U</option>
        </select>
      </div>
      
      <div class="filter-group">
        <span class="filter-label">Status:</span>
        <select id="filter-status" class="filter-select">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="waitlist">Waitlist</option>
        </select>
      </div>
      
      <div class="filter-group">
        <span class="filter-label">Tryout Date:</span>
        <select id="filter-date" class="filter-select">
          <option value="">All</option>
          <option value="nov-9-12u-14u">Nov 9 (12U-14U)</option>
          <option value="nov-16-15u-16u">Nov 16 (15U-16U)</option>
          <option value="nov-16-17u-18u">Nov 16 (17U-18U)</option>
        </select>
      </div>
    </div>
    
    <table class="admin-table">
      <thead>
        <tr>
          <th>Player Name</th>
          <th>Age Group</th>
          <th>Position</th>
          <th>Parent/Guardian</th>
          <th>Tryout Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="registrations-table-body">
        <!-- Table rows will be populated by JavaScript -->
        <tr>
          <td colspan="7" style="text-align: center; padding: 30px;">Loading registrations...</td>
        </tr>
      </tbody>
    </table>
    
    <div class="pagination" id="pagination">
      <!-- Pagination buttons will be added by JavaScript -->
    </div>
  </main>
  
  <!-- Registration Details Modal -->
  <div id="details-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="close-modal">&times;</span>
      <h2 class="modal-title">Registration Details</h2>
      
      <div id="registration-details">
        <!-- Details will be populated by JavaScript -->
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn btn-cancel" id="cancel-btn">Cancel</button>
        <button class="modal-btn btn-save" id="save-btn">Save Changes</button>
      </div>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      query, 
      where, 
      orderBy, 
      limit, 
      startAfter 
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDmsZlmti2s_-tnmfzu2dl3JXHc-O_MFIo",
      authDomain: "tvvc-website.firebaseapp.com",
      projectId: "tvvc-website",
      storageBucket: "tvvc-website.firebasestorage.app",
      messagingSenderId: "235626883938",
      appId: "1:235626883938:web:109885d0682b9080bd1a3b"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // Redirect to login page if not authenticated
        window.location.href = "login.html";
      } else {
        // User is authenticated, initialize the admin panel
        initAdminPanel();
      }
    });
    
    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      signOut(auth).then(() => {
        window.location.href = "login.html";
      }).catch((error) => {
        console.error("Error signing out:", error);
      });
    });
    
    // Admin panel initialization
    function initAdminPanel() {
      // State variables
      let currentRegistrations = [];
      let lastVisible = null;
      let currentPage = 1;
      let itemsPerPage = 10;
      let filters = {
        search: '',
        ageGroup: '',
        status: '',
        tryoutDate: ''
      };
      
      // DOM elements
      const tableBody = document.getElementById('registrations-table-body');
      const paginationContainer = document.getElementById('pagination');
      const detailsModal = document.getElementById('details-modal');
      const closeModal = document.getElementById('close-modal');
      const cancelBtn = document.getElementById('cancel-btn');
      const saveBtn = document.getElementById('save-btn');
      const refreshBtn = document.getElementById('refresh-btn');
      const exportCsvBtn = document.getElementById('export-csv');
      const loadingOverlay = document.getElementById('loading-overlay');
      const searchInput = document.getElementById('search-input');
      const filterAge = document.getElementById('filter-age');
      const filterStatus = document.getElementById('filter-status');
      const filterDate = document.getElementById('filter-date');
      
      // Initial data load
      loadRegistrations();
      
      // Event listeners
      refreshBtn.addEventListener('click', loadRegistrations);
      closeModal.addEventListener('click', closeDetailsModal);
      cancelBtn.addEventListener('click', closeDetailsModal);
      saveBtn.addEventListener('click', saveRegistrationChanges);
      exportCsvBtn.addEventListener('click', exportToCsv);
      
      // Filter event listeners
      searchInput.addEventListener('input', debounce(applyFilters, 300));
      filterAge.addEventListener('change', applyFilters);
      filterStatus.addEventListener('change', applyFilters);
      filterDate.addEventListener('change', applyFilters);
      
      // Load registrations from Firestore
      async function loadRegistrations() {
        showLoading();
        
        try {
          const registrationsRef = collection(db, 'tryoutRegistrations');
          const q = query(registrationsRef, orderBy('registrationDate', 'desc'));
          const querySnapshot = await getDocs(q);
          
          currentRegistrations = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            currentRegistrations.push({
              id: doc.id,
              ...data
            });
          });
          
          applyFilters();
        } catch (error) {
          console.error("Error loading registrations:", error);
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 30px; color: #F44336;">
                Error loading registrations. Please try again.
              </td>
            </tr>
          `;
        } finally {
          hideLoading();
        }
      }
      
      // Apply filters and update table
      function applyFilters() {
        // Update filter values
        filters.search = searchInput.value.toLowerCase();
        filters.ageGroup = filterAge.value;
        filters.status = filterStatus.value;
        filters.tryoutDate = filterDate.value;
        
        // Filter registrations
        const filtered = currentRegistrations.filter(reg => {
          // Search filter
          const searchMatch = !filters.search || 
            (reg.playerInfo?.firstName?.toLowerCase().includes(filters.search) ||
             reg.playerInfo?.lastName?.toLowerCase().includes(filters.search) ||
             reg.guardianInfo?.email?.toLowerCase().includes(filters.search) ||
             reg.playerInfo?.school?.toLowerCase().includes(filters.search));
          
          // Age group filter
          const ageGroupMatch = !filters.ageGroup || reg.playerInfo?.ageGroup === filters.ageGroup;
          
          // Status filter
          const statusMatch = !filters.status || reg.status === filters.status;
          
          // Tryout date filter
          const dateMatch = !filters.tryoutDate || reg.tryoutSession === filters.tryoutDate;
          
          return searchMatch && ageGroupMatch && statusMatch && dateMatch;
        });
        
        // Reset pagination
        currentPage = 1;
        renderTable(filtered);
        renderPagination(filtered.length);
      }
      
      // Render table with data
      function renderTable(data) {
        if (data.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 30px;">
                No registrations found matching your filters.
              </td>
            </tr>
          `;
          return;
        }
        
        // Calculate pagination
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedData = data.slice(start, end);
        
        // Clear table
        tableBody.innerHTML = '';
        
        // Add rows
        paginatedData.forEach(reg => {
          const row = document.createElement('tr');
          
          // Format tryout date for display
          let tryoutDateDisplay = 'Unknown';
          if (reg.tryoutSession === 'nov-9-12u-14u') {
            tryoutDateDisplay = 'Nov 9 (12U-14U)';
          } else if (reg.tryoutSession === 'nov-16-15u-16u') {
            tryoutDateDisplay = 'Nov 16 (15U-16U)';
          } else if (reg.tryoutSession === 'nov-16-17u-18u') {
            tryoutDateDisplay = 'Nov 16 (17U-18U)';
          }
          
          // Create status badge class
          const statusClass = `status-${reg.status || 'pending'}`;
          
          row.innerHTML = `
            <td>${reg.playerInfo?.firstName || ''} ${reg.playerInfo?.lastName || ''}</td>
            <td>${reg.playerInfo?.ageGroup || ''}</td>
            <td>${reg.volleyballExperience?.primaryPosition || ''}</td>
            <td>${reg.guardianInfo?.name || ''}</td>
            <td>${tryoutDateDisplay}</td>
            <td><span class="status-badge ${statusClass}">${(reg.status || 'pending').toUpperCase()}</span></td>
            <td class="action-buttons">
              <button class="action-btn action-view" data-id="${reg.id}" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn action-edit" data-id="${reg.id}" title="Edit Status">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn action-delete" data-id="${reg.id}" title="Delete Registration">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          
          tableBody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.action-view, .action-edit').forEach(btn => {
          btn.addEventListener('click', () => openDetailsModal(btn.dataset.id));
        });
        
        document.querySelectorAll('.action-delete').forEach(btn => {
          btn.addEventListener('click', () => confirmDelete(btn.dataset.id));
        });
      }
      
      // Render pagination controls
      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        if (totalPages <= 1) {
          paginationContainer.innerHTML = '';
          return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
          <button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                  ${currentPage === 1 ? 'disabled' : ''} 
                  data-page="${currentPage - 1}">
            <i class="fas fa-chevron-left"></i>
          </button>
        `;
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `
            <button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">
              ${i}
            </button>
          `;
        }
        
        // Next button
        paginationHTML += `
          <button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                  ${currentPage === totalPages ? 'disabled' : ''} 
                  data-page="${currentPage + 1}">
            <i class="fas fa-chevron-right"></i>
          </button>
        `;
        
        paginationContainer.innerHTML = paginationHTML;
        
        // Add event listeners to pagination buttons
        document.querySelectorAll('.page-btn:not(.disabled)').forEach(btn => {
          btn.addEventListener('click', () => {
            currentPage = parseInt(btn.dataset.page);
            applyFilters();
            window.scrollTo(0, 0);
          });
        });
      }
      
      // Open registration details modal
      function openDetailsModal(id) {
        const registration = currentRegistrations.find(reg => reg.id === id);
        if (!registration) return;
        
        const detailsContainer = document.getElementById('registration-details');
        
        // Format registration date
        let registrationDate = 'Unknown';
        if (registration.registrationDate && registration.registrationDate.toDate) {
          registrationDate = registration.registrationDate.toDate().toLocaleString();
        }
        
        // Format tryout date for display
        let tryoutDateDisplay = 'Unknown';
        if (registration.tryoutSession === 'nov-9-12u-14u') {
          tryoutDateDisplay = 'November 9, 2025 | 5:00-7:00 PM (12U-14U)';
        } else if (registration.tryoutSession === 'nov-16-15u-16u') {
          tryoutDateDisplay = 'November 16, 2025 | 4:00-6:00 PM (15U-16U)';
        } else if (registration.tryoutSession === 'nov-16-17u-18u') {
          tryoutDateDisplay = 'November 16, 2025 | 6:30-8:30 PM (17U-18U)';
        }
        
        detailsContainer.innerHTML = `
          <div class="detail-section">
            <h3 class="detail-section-title">Player Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">First Name</div>
                <div class="detail-value">${registration.playerInfo?.firstName || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Last Name</div>
                <div class="detail-value">${registration.playerInfo?.lastName || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Birth Date</div>
                <div class="detail-value">${registration.playerInfo?.birthDate || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Grade</div>
                <div class="detail-value">${registration.playerInfo?.grade || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Age Group</div>
                <div class="detail-value">${registration.playerInfo?.ageGroup || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">School</div>
                <div class="detail-value">${registration.playerInfo?.school || 'N/A'}</div>
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h3 class="detail-section-title">Volleyball Experience</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Primary Position</div>
                <div class="detail-value">${registration.volleyballExperience?.primaryPosition || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Secondary Position</div>
                <div class="detail-value">${registration.volleyballExperience?.secondaryPosition || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Experience Level</div>
                <div class="detail-value">${registration.volleyballExperience?.experienceLevel || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Previous Club</div>
                <div class="detail-value">${registration.volleyballExperience?.previousClub || 'N/A'}</div>
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h3 class="detail-section-title">Parent/Guardian Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Name</div>
                <div class="detail-value">${registration.guardianInfo?.name || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Relationship</div>
                <div class="detail-value">${registration.guardianInfo?.relationship || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email</div>
                <div class="detail-value">${registration.guardianInfo?.email || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Phone</div>
                <div class="detail-value">${registration.guardianInfo?.phone || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Address</div>
                <div class="detail-value">${registration.guardianInfo?.address || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">City</div>
                <div class="detail-value">${registration.guardianInfo?.city || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">ZIP</div>
                <div class="detail-value">${registration.guardianInfo?.zip || 'N/A'}</div>
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h3 class="detail-section-title">Tryout Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Tryout Session</div>
                <div class="detail-value">${tryoutDateDisplay}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Registration Date</div>
                <div class="detail-value">${registrationDate}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email Consent</div>
                <div class="detail-value">${registration.emailConsent ? 'Yes' : 'No'}</div>
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h3 class="detail-section-title">Status</h3>
            <select id="status-select" class="status-select">
              <option value="pending" ${registration.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="approved" ${registration.status === 'approved' ? 'selected' : ''}>Approved</option>
              <option value="rejected" ${registration.status === 'rejected' ? 'selected' : ''}>Rejected</option>
              <option value="waitlist" ${registration.status === 'waitlist' ? 'selected' : ''}>Waitlist</option>
            </select>
          </div>
        `;
        
        // Store the current registration ID for the save button
        saveBtn.dataset.id = id;
        
        // Show modal
        detailsModal.style.display = 'block';
      }
      
      // Close details modal
      function closeDetailsModal() {
        detailsModal.style.display = 'none';
      }
      
      // Save registration changes
      async function saveRegistrationChanges() {
        const id = saveBtn.dataset.id;
        const newStatus = document.getElementById('status-select').value;
        
        showLoading();
        
        try {
          const registrationRef = doc(db, 'tryoutRegistrations', id);
          await updateDoc(registrationRef, {
            status: newStatus,
            lastUpdated: new Date()
          });
          
          // Update local data
          const index = currentRegistrations.findIndex(reg => reg.id === id);
          if (index !== -1) {
            currentRegistrations[index].status = newStatus;
            currentRegistrations[index].lastUpdated = new Date();
          }
          
          // Close modal and refresh table
          closeDetailsModal();
          applyFilters();
        } catch (error) {
          console.error("Error updating registration:", error);
          alert("Error updating registration. Please try again.");
        } finally {
          hideLoading();
        }
      }
      
      // Confirm and delete registration
      function confirmDelete(id) {
        if (confirm("Are you sure you want to delete this registration? This action cannot be undone.")) {
          deleteRegistration(id);
        }
      }
      
      // Delete registration
      async function deleteRegistration(id) {
        showLoading();
        
        try {
          const registrationRef = doc(db, 'tryoutRegistrations', id);
          await deleteDoc(registrationRef);
          
          // Remove from local data
          currentRegistrations = currentRegistrations.filter(reg => reg.id !== id);
          
          // Refresh table
          applyFilters();
        } catch (error) {
          console.error("Error deleting registration:", error);
          alert("Error deleting registration. Please try again.");
        } finally {
          hideLoading();
        }
      }
      
      // Export to CSV
      function exportToCsv() {
        // Apply current filters to data
        const filtered = currentRegistrations.filter(reg => {
          const searchMatch = !filters.search || 
            (reg.playerInfo?.firstName?.toLowerCase().includes(filters.search) ||
             reg.playerInfo?.lastName?.toLowerCase().includes(filters.search) ||
             reg.guardianInfo?.email?.toLowerCase().includes(filters.search) ||
             reg.playerInfo?.school?.toLowerCase().includes(filters.search));
          
          const ageGroupMatch = !filters.ageGroup || reg.playerInfo?.ageGroup === filters.ageGroup;
          const statusMatch = !filters.status || reg.status === filters.status;
          const dateMatch = !filters.tryoutDate || reg.tryoutSession === filters.tryoutDate;
          
          return searchMatch && ageGroupMatch && statusMatch && dateMatch;
        });
        
        if (filtered.length === 0) {
          alert("No data to export.");
          return;
        }
        
        // CSV headers
        const headers = [
          "Player First Name",
          "Player Last Name",
          "Birth Date",
          "Grade",
          "Age Group",
          "School",
          "Primary Position",
          "Secondary Position",
          "Experience Level",
          "Previous Club",
          "Parent/Guardian Name",
          "Relationship",
          "Email",
          "Phone",
          "Address",
          "City",
          "ZIP",
          "Tryout Session",
          "Registration Date",
          "Status",
          "Email Consent"
        ];
        
        // Create CSV content
        let csvContent = headers.join(",") + "\n";
        
        filtered.forEach(reg => {
          // Format registration date
          let registrationDate = "";
          if (reg.registrationDate && reg.registrationDate.toDate) {
            registrationDate = reg.registrationDate.toDate().toISOString().split('T')[0];
          }
          
          // Format tryout session
          let tryoutSession = reg.tryoutSession || "";
          if (tryoutSession === 'nov-9-12u-14u') {
            tryoutSession = "November 9 (12U-14U)";
          } else if (tryoutSession === 'nov-16-15u-16u') {
            tryoutSession = "November 16 (15U-16U)";
          } else if (tryoutSession === 'nov-16-17u-18u') {
            tryoutSession = "November 16 (17U-18U)";
          }
          
          // Create row data
          const row = [
            escapeCsvValue(reg.playerInfo?.firstName || ""),
            escapeCsvValue(reg.playerInfo?.lastName || ""),
            escapeCsvValue(reg.playerInfo?.birthDate || ""),
            escapeCsvValue(reg.playerInfo?.grade || ""),
            escapeCsvValue(reg.playerInfo?.ageGroup || ""),
            escapeCsvValue(reg.playerInfo?.school || ""),
            escapeCsvValue(reg.volleyballExperience?.primaryPosition || ""),
            escapeCsvValue(reg.volleyballExperience?.secondaryPosition || ""),
            escapeCsvValue(reg.volleyballExperience?.experienceLevel || ""),
            escapeCsvValue(reg.volleyballExperience?.previousClub || ""),
            escapeCsvValue(reg.guardianInfo?.name || ""),
            escapeCsvValue(reg.guardianInfo?.relationship || ""),
            escapeCsvValue(reg.guardianInfo?.email || ""),
            escapeCsvValue(reg.guardianInfo?.phone || ""),
            escapeCsvValue(reg.guardianInfo?.address || ""),
            escapeCsvValue(reg.guardianInfo?.city || ""),
            escapeCsvValue(reg.guardianInfo?.zip || ""),
            escapeCsvValue(tryoutSession),
            escapeCsvValue(registrationDate),
            escapeCsvValue(reg.status || "pending"),
            reg.emailConsent ? "Yes" : "No"
          ];
          
          csvContent += row.join(",") + "\n";
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `tryout-registrations-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // Helper function to escape CSV values
      function escapeCsvValue(value) {
        if (value === null || value === undefined) return "";
        value = String(value);
        
        // If the value contains a comma, quote, or newline, wrap it in quotes
        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
          // Double any existing quotes
          value = value.replace(/"/g, '""');
          return `"${value}"`;
        }
        return value;
      }
      
      // Show loading overlay
      function showLoading() {
        loadingOverlay.style.display = 'flex';
      }
      
      // Hide loading overlay
      function hideLoading() {
        loadingOverlay.style.display = 'none';
      }
      
      // Debounce function for search input
      function debounce(func, delay) {
        let timeout;
        return function() {
          const context = this;
          const args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      }
    }
  </script>
</body>
</html>